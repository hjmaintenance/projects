@using MIT.Razor.Pages.Component.Grid
@using MIT.Razor.Pages.Component.Grid.RepositoryItem
@using MIT.Razor.Pages.Component.DataEdits
@using MIT.UI.LIB.DataEdits
@using MIT.UI.LIB.Grid.RepositoryItem
@using MIT.UI.UMS
@using System.Data
@using System.Linq
@using Microsoft.JSInterop
@using System.Linq.Expressions

@inherits UH2090QA1Base
@{
    /*
  * 작성자명 : jskim
  * 작성일자 : 25-05-22
  * 최종수정 : 25-05-22
  * 화면ID : UH2090QA1
  * 화면명 : 용수 사용량 조회
  * 프로시저 :  P_HMI_WAT_ACTUAL_VAL_CHOICE
  */
            }
            <DxFormLayout CssClass="w-100">
                @{
        /* search area */
    }
    <DxFormLayoutGroup Caption="조회조건" CssClass="mit-search-area" Decoration="FormLayoutGroupDecoration.Card" ColSpanSm="12">
        <DxFormLayoutItem Caption="구분" ColSpanSm="2"><MitCombo CodeId="ST_WA_GRP" @bind-Value="@P_WA_GRP" /></DxFormLayoutItem>
        <DxFormLayoutItem Caption="기간선택" ColSpanSm="2"><CommonDateEdit @ref="P_SDATE" /></DxFormLayoutItem>
        <DxFormLayoutItem Caption="-" ColSpanSm="2"><CommonDateEdit @ref="P_EDATE" /></DxFormLayoutItem>




        <DxFormLayoutItem Caption="수용가" ColSpanSm="2">
      <MitCombo CodeId="company2" Etc0="WA"
                      @ref="@P_COM_ID"
                      @bind-Value=@P_COM_VAL
                      SelectedItemChanged="COM_Chnage" SearchMode="ListSearchMode.AutoSearch" SearchFilterCondition="ListSearchFilterCondition.Contains"
                      IsAll=true />
        </DxFormLayoutItem>
        <DxFormLayoutItem Caption="계량기" ColSpanSm="2">
            <MitCombo CodeId="FDR" @ref="@P_MC_ID" IsDataFixed="false"
                      IsAll=true />
        </DxFormLayoutItem>









    </DxFormLayoutGroup>
    @{
        /* content area */
    }
    <DxFormLayoutGroup Caption="" CssClass="mit-content-area" Decoration="FormLayoutGroupDecoration.Card" ColSpanSm="12">
        <DxFormLayoutItem ColSpanSm="12">
            <DxRangeSelector Width="100%" ValueChanged="@OnValueChanged" AllowSliderSwap="true"
                             SelectedRangeStartValue=@sval SelectedRangeEndValue=@eval>

                <DxRangeSelectorScale StartValue="1" EndValue="@mc_num" TickInterval="1" MinRange="gapval" MaxRange="gapval" ValueType="ChartAxisDataType.Numeric">
                </DxRangeSelectorScale>
            </DxRangeSelector>


            <CommonGrid @ref="Grd1" CssClass="mit-grid"
                        IsShowToolBar="true"
                        @* ExcludeColumnsOnExport = @ExcFieldName *@
                        IsExportDocEnabled="false"
                        IsExportPdfEnabled="false"
                        IsExportXlsxEnabled="false"
                        IsExportImageEnabled=false>
                <DataColumnsTemplate>
                    <DxGridDataColumn Caption="구분1" FixedPosition="GridColumnFixedPosition.Left" FieldName="GAUGE_DATE" Width="80" TextAlignment="GridTextAlignment.Center" CaptionAlignment="GridTextAlignment.Center"><CellDisplayTemplate Context="context2"><RepositoryItemTextBox CellContext="context2" ReadOnly="true" /></CellDisplayTemplate></DxGridDataColumn>
                    <DxGridDataColumn Caption="구분2" FixedPosition="GridColumnFixedPosition.Left" FieldName="GAUGE_MIN" Width="80" TextAlignment="GridTextAlignment.Center" CaptionAlignment="GridTextAlignment.Center"><CellDisplayTemplate Context="context2"><RepositoryItemTextBox CellContext="context2" ReadOnly="true" /></CellDisplayTemplate></DxGridDataColumn>

                    @for (int i = 1; i <= 30; i++)
                    {
                        var k = i;

                        @* <DxGridDataColumn Caption='@( ReVal("MC_ID_", k) )' FieldName="@( ReVal("MC_ID_", k) )" Width="80" CaptionAlignment="GridTextAlignment.Center" /> *@
                        <DxGridBandColumn Caption="@(ReVal_SP(Colnames[ReVal("MC_ID_", k)]+""))" CaptionAlignment="GridTextAlignment.Center" Visible=@(( k >= sval && k <= eval ))>
                            <Columns>
                                <DxGridDataColumn Caption='평균' FieldName="@( ReVal("USEQTY_", k) )" Width="80" CaptionAlignment="GridTextAlignment.Center" Visible=@(searched_grp?.Split("_")[0] =="SIGNAL") />
                                <DxGridDataColumn Caption='사용량' FieldName="@( ReVal("I_USEQTY_", k) )" Width="80" CaptionAlignment="GridTextAlignment.Center" Visible=@(searched_grp?.Split("_")[0] =="SIGNAL") />
                                @*정산량은 월보와 년보에만*@
                                <DxGridDataColumn Caption='정산량' FieldName="@( ReVal("MQ_TON_", k) )" Width="80" CaptionAlignment="GridTextAlignment.Center" Visible=@(searched_grp =="SIGNAL_YEAR_W" || searched_grp == "SIGNAL_MONTH_W" ) />
                                <DxGridDataColumn Caption='적산' FieldName="@( ReVal("AC_TON_", k) )" Width="80" CaptionAlignment="GridTextAlignment.Center" Visible=@(searched_grp != "ACCEPT_W" && searched_grp != "FILTER_W") />
                                <DxGridDataColumn Caption='수용량' FieldName="@( ReVal("D_USEQTY_", k) )" Width="80" CaptionAlignment="GridTextAlignment.Center" TextAlignment="GridTextAlignment.Right" Visible=@(searched_grp == "ACCEPT_W" || searched_grp == "FILTER_W")/>
                            </Columns>
                        </DxGridBandColumn>

                    }
                    @*적산에서 합계열 보기위함. 적산 이외에는 사용안할듯? as-is화면 끊겨있어서 확인불가*@
                    <DxGridDataColumn Caption='합계' FieldName="AC_TON_31" FixedPosition="GridColumnFixedPosition.Right" Width="140" CaptionAlignment="GridTextAlignment.Center" Visible=@(searched_grp?.Split("_")[0] =="ALL") />

                </DataColumnsTemplate>
            </CommonGrid>
        </DxFormLayoutItem>
    </DxFormLayoutGroup>
</DxFormLayout>



@code {
    protected async void OnValueChanged(RangeSelectorValueChangedEventArgs info)
    {
        sval = int.Parse((info.CurrentRange[0] + "").Split('.')[0]);
        eval = int.Parse((info.CurrentRange[1] + "").Split('.')[0]);

        StateHasChanged();
    }



    private async void COM_Chnage(Razor.Pages.CommCode args)
    {
        P_MC_ID.Etc0 = args.Name;
    }


}

<style>
    .crr-pg-UH2090QA1 .common-control-page-height {
        top: -113px;
        position: relative;
        height: calc(100vh - 300px);
    }


    .crr-pg-UH2090QA1 .dxbl-toolbar.dxbl-toolbar-adaptive > .dxbl-btn-toolbar {
        background-color: var(--bg-main) !important;
    }

    .crr-pg-UH2090QA1.mit-crr-page {
        height: calc(100vh - 200px) !important;
        overflow: hidden !important;
    }

    .crr-pg-UH2090QA1 .common-layout-grid {
        height: calc(100vh - 381px) !important;
    }

    .crr-pg-UH2090QA1 .mit-grid {
        height: calc(100vh - 24rem) !important;
        width: 100% !important;
        max-width: 100% !important;
    }
</style>