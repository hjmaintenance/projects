@using MIT.Razor.Pages.Component.Grid.RepositoryItem
@using System.Data

@inherits RepositoryItemImageComboBox

<RepositoryItemImageComboBox DisplayFieldName="@DisplayFieldName"
                             ValueFieldName="@ValueFieldName"
                             AllowEdit="@AllowEdit"
                             IsPrimaryKey="@IsPrimaryKey"
                             ReadOnly="@ReadOnly"
                             Enable="@Enable"
                             DataSource="@DataSource"
                             ValueChanged="@ValueChanged"
                             CellContext="CellContext">
</RepositoryItemImageComboBox>

@code {


    #region [조회조건]
    /// <summary>
    /// 그룹코드
    /// 필수입력
    /// </summary>
    [Parameter]
    public string GroupCode { get; set; } = string.Empty;
    [Parameter]
    public string CodeName { get; set; } = string.Empty;
    [Parameter]
    public string OPT01 { get; set; } = string.Empty;
    [Parameter]
    public string OPT02 { get; set; } = string.Empty;
    [Parameter]
    public string OPT03 { get; set; } = string.Empty;
    [Parameter]
    public string OPT04 { get; set; } = string.Empty;
    [Parameter]
    public string OPT05 { get; set; } = string.Empty;

    #endregion [조회조건]

    [Parameter]
    public string QueryName { get; set; } = "SP_COMBO_COM_CODE_SELECT";


    protected override async Task OnInitializedAsync()
    {
        base.OnInitialized();

        DisplayFieldName = "CODE_NAME";
        ValueFieldName = "CODE";

        await LoadData();
    }

    public async Task LoadData()
    {
        DataSource = await DBSearch();
        StateHasChanged();
    }

    #region [ 데이터 정의 메소드 ]

    private async Task<DataTable?> DBSearch()
    {
        if (QueryService == null)
            throw new Exception("QueryService가 Null 입니다.");

        if (QueryName == null)
            throw new Exception("QueryName의 값이 없습니다.");

        var datatable = await QueryService.ExecuteDatatableAsync(QueryName, new Dictionary<string, object?>()
        {
            { "PARENT_CODE", GroupCode },
            { "CODE_NAME", CodeName },
            { "OPT01", OPT01 },
            { "OPT02", OPT02 },
            { "OPT03", OPT03 },
            { "OPT04", OPT04 },
            { "OPT05", OPT05 },
        });

        return datatable;
    }

    #endregion [ 데이터 정의 메소드 ]
}
