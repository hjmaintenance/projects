name: Push Email Notification

on:
  push:
    branches:
      - main 

jobs:
  send_email:
    runs-on: ubuntu-latest

    steps:
      - name: Generate HTML with all commits
        id: generate_html
        run: |
          echo "<!DOCTYPE html>
          <html lang='en'>
          <head>
          <meta charset='UTF-8'>
          <title>GitHub Push Notification</title>
          <style>
            body { font-family: Arial, sans-serif; background-color:#f4f4f7; margin:0; padding:20px; }
            .card { background:white; border-radius:12px; padding:20px; max-width:500px; margin:auto; border-left:6px solid #0366d6; }
            .header { font-size:20px; font-weight:bold; color:#24292f; margin-bottom:20px; display:flex; align-items:center; }
            .header span { margin-left:10px; }
            .item { margin-bottom:15px; line-height:1; display:flex; align-items:center; }
            .item-icon { font-size:18px; margin-right:10px; }
            .item strong { color:#0366d6; width:130px; display:inline-block; }
            .link-button { display:inline-block; padding:4px 8px; font-size:13px; background-color:#28a745; color:white; border-radius:5px; text-decoration:none; font-weight:bold; margin-top:5px; }
            .link-button:hover { background-color:#218838; }
            .footer { margin-top:25px; font-size:13px; color:#555; text-align:center; }
          </style>
          </head>
          <body>
            <div class='card'>
              <div class='header'>üì¢ <span>GitHub Repository Push Notification</span></div>
              <div class='item'><span class='item-icon'>üìÇ</span><strong>Repository:</strong> ${{ github.repository }}</div>
              <div class='item'><span class='item-icon'>üë§</span><strong>Pushed by:</strong> ${{ github.actor }}</div>" > commit_list.html

          echo "${{ toJson(github.event.commits) }}" | jq -c '.[]' | while read commit; do
            msg=$(echo "$commit" | jq -r '.message')
            author=$(echo "$commit" | jq -r '.author.name')
            echo "<div class='item'><span class='item-icon'>üìù</span><strong>Commit:</strong> $msg (by $author)</div>" >> commit_list.html
          done

          echo "<div class='item'><span class='item-icon'>üîó</span><strong>Compare changes:</strong> <a class='link-button' href='${{ github.event.compare }}'>View Changes</a></div>
              <div class='footer'>‚ú® Take a peek at what‚Äôs new!</div>
            </div>
          </body>
          </html>" >> commit_list.html

          echo "html_body<<EOF" >> $GITHUB_ENV
          cat commit_list.html >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send mail on push
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üì¨ [${{ github.repository }}] New Push by ${{ github.actor }}"
          to: "anstnwl27@gmail.com "
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"
          html_body: ${{ env.html_body }}