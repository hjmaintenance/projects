name: Push Email Notification

on:
  push:
    branches:
      - main 

jobs:
  send_email:
    runs-on: ubuntu-latest

    steps:


      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract commit info
        id: commit
        run: |
          # Ï†úÎ™©, Î≥∏Î¨∏
          SUBJECT="$(git log -1 --pretty=%s)"
          BODY="$(git log -1 --pretty=%b)"

          echo "Full Subject: $SUBJECT"
          echo "Body: $BODY"

          # Ï†ëÏàòÏôÄ Íµ¨Î∂Ñ
          if [[ "$SUBJECT" == reception_alert:* ]]; then
            CLEAN_SUBJECT="${SUBJECT#reception_alert:}"   # Íµ¨Î∂ÑÍ∞í ÎÇ†Î¶º.
            echo "mail_subject=$CLEAN_SUBJECT" >> $GITHUB_OUTPUT

            echo "mail_body=$BODY" >> $GITHUB_OUTPUT

          else
            echo "mail_subject=üì¨ [${{ github.repository }}] New Push by ${{ github.actor }}" >> $GITHUB_OUTPUT
            

            cat <<'EOF' > html_body.txt
            <!DOCTYPE html>
            <html lang="ko">
            <head>
              <meta charset="UTF-8">
              <title>GitHub Push Notification</title>
            </head>
            <body style="margin:0; padding:20px; font-family:Arial, sans-serif; background-color:#f4f4f7;">
              <div style="background-color:white; border:1px solid #0366d6; border-radius:12px; padding:20px; max-width:500px;">
                <div style="font-size:20px; font-weight:bold; color:#24292f; margin-bottom:20px; display:flex; align-items:center;">
                  <span style="margin-right:10px;">üì¢</span>
                  <span>GitHub Repository Push Notification</span>
                </div>
                <div style="display:flex; align-items:center; margin-bottom:10px; line-height:1.2;">
                  <span style="width:28px; text-align:center; display:inline-block;">üìÇ</span>
                  <strong style="color:#0366d6; width:130px; display:inline-block;">Repository:</strong>
                  <span>${GITHUB_REPOSITORY}</span>
                </div>
                <div style="display:flex; align-items:center; margin-bottom:10px; line-height:1.2;">
                  <span style="width:28px; text-align:center; display:inline-block;">üë§</span>
                  <strong style="color:#0366d6; width:130px; display:inline-block;">Pushed by:</strong>
                  <span>${GITHUB_ACTOR}</span>
                </div>
                <div style="display:flex; align-items:center; margin-bottom:10px; line-height:1.2;">
                  <span style="width:28px; text-align:center; display:inline-block;">üìù</span>
                  <strong style="color:#0366d6; width:130px; display:inline-block;">Commit message:</strong>
                  <span>${BODY}</span>
                </div>
                <div style="display:flex; align-items:center; margin-bottom:10px; line-height:1.2;">
                  <span style="width:28px; text-align:center; display:inline-block;">üîó</span>
                  <strong style="color:#0366d6; width:130px; display:inline-block;">Compare changes:</strong>
                  <a href="${GITHUB_EVENT_COMPARE}" style="display:inline-block; padding:4px 8px; font-size:13px; background-color:#28a745; color:white; border-radius:5px; text-decoration:none; font-weight:bold;">View Changes</a>
                </div>
                <div style="margin-top:20px; font-size:13px; color:#555; text-align:center;">
                  ‚ú® Take a peek at what‚Äôs new!
                </div>
              </div>
            </body>
            </html>
            EOF

            HTML_BODY=$(cat html_body.txt)
            echo "mail_body=$HTML_BODY" >> $GITHUB_OUTPUT
            echo "use_html=true" >> $GITHUB_OUTPUT
          fi







      - name: Send mail on push
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.commit.outputs.mail_subject }}
          to: "quristyle@gmail.com" #, uspuni@gmail.com, utmost793@daum.net, anstnwl27@gmail.com, a0624z@naver.com "
          from: "hjmaintenance"
          body: ${{ steps.commit.outputs.mail_body }}
          html_body: ${{ steps.commit.outputs.mail_body }}